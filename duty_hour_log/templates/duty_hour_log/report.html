<!-- duty_hour_log/templates/duty_hour_log/report.html -->
{% extends 'duty_hour_log/base.html' %}

{% block title %}Duty Log Report{% endblock %}

{% block content %}
<div class="row">
    <div class="col-lg-10 offset-lg-1">
        <h2 class="mb-4"><i class="fas fa-chart-bar"></i> Duty Log Report Generator</h2>

        <div class="card mb-4">
            <div class="card-header">
                <i class="fas fa-filter"></i> Report Filters
            </div>
            <div class="card-body">
                {# Use GET method so filters stay in URL #}
                <form method="get" action="{% url 'report_view' %}">
                    <div class="row g-3 align-items-end">
                        <div class="col-md-3">
                            {{ form.start_date.label_tag }}
                            {{ form.start_date }}
                            {% if form.start_date.errors %}<div class="invalid-feedback d-block">{{ form.start_date.errors|join:", " }}</div>{% endif %}
                        </div>
                        <div class="col-md-3">
                            {{ form.end_date.label_tag }}
                            {{ form.end_date }}
                            {% if form.end_date.errors %}<div class="invalid-feedback d-block">{{ form.end_date.errors|join:", " }}</div>{% endif %}
                        </div>
                         <div class="col-md-3">
                            {{ form.initial.label_tag }}
                            {{ form.initial }}
                            {% if form.initial.errors %}<div class="invalid-feedback d-block">{{ form.initial.errors|join:", " }}</div>{% endif %}
                        </div>
                        <div class="col-md-3">
                            {{ form.op.label_tag }}
                            {{ form.op }}
                            {% if form.op.errors %}<div class="invalid-feedback d-block">{{ form.op.errors|join:", " }}</div>{% endif %}
                        </div>
                        <div class="col-md-3">
                            {{ form.rating.label_tag }}
                            {{ form.rating }}
                            {% if form.rating.errors %}<div class="invalid-feedback d-block">{{ form.rating.errors|join:", " }}</div>{% endif %}
                        </div>

                        <div class="col-md-3">
                            <button type="submit" class="btn btn-primary w-100"><i class="fas fa-search"></i> Generate Report</button>
                        </div>
                         {% if form.non_field_errors %}
                            <div class="col-12 text-danger mt-2">
                                {{ form.non_field_errors }}
                            </div>
                        {% endif %}
                         {# Display clean errors like end_date < start_date #}
                         {% if form.errors and not form.non_field_errors %}
                             {% for field, errors in form.errors.items %}
                                 {% if field == '__all__' %}
                                 <div class="col-12 text-danger mt-2">
                                    {{ errors|join:", " }}
                                 </div>
                                 {% endif %}
                             {% endfor %}
                         {% endif %}
                    </div>
                    {% if form.initial.help_text %}
                        <small class="form-text text-muted d-block mt-2">{{ form.initial.help_text }}</small>
                    {% endif %}
                </form>
            </div>
        </div>

        {% if has_results %}
        <div class="card border-success">
            <div class="card-header bg-success text-white">
                 <i class="fas fa-check-circle"></i> Report Results
            </div>
            <div class="card-body">
                <h5 class="card-title">Summary</h5>
                <p>Based on the following filters:</p>
                <ul>
                    <li><strong>Date Range:</strong> {{ submitted_filters.start_date|date:"Y-m-d" }} to {{ submitted_filters.end_date|date:"Y-m-d" }}</li>
                    <li><strong>Initial:</strong> {{ submitted_filters.initial }}</li>
                    <li><strong>Operation Type:</strong> {{ submitted_filters.op }}</li>
                    <li><strong>Rating:</strong> {{ submitted_filters.rating }}</li>
                </ul>
                <hr>
                <h4>Total Duration: <span class="badge bg-primary">{{ total_hours|floatformat:2 }} hours</span></h4>

                {% if filtered_logs %}
                    <h5 class="mt-4">Matching Log Entries ({{ filtered_logs.count }})</h5>
                     <div class="table-responsive mt-3" style="max-height: 400px; overflow-y: auto;">
                        <table class="table table-sm table-striped table-bordered small">
                            <thead class="table-light sticky-top">
                                <tr>
                                    <th>Date</th>
                                    <th>Start</th>
                                    <th>Finish</th>
                                    <th>Op</th>
                                    <th>Rating</th>
                                    <th>Initial</th>
                                    <th>Trainee</th>
                                    <th>OJTI</th>
                                    <th>Examiner</th>
                                    <th>Duration (HH:MM)</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for log in filtered_logs %}
                                <tr>
                                    <td>{{ log.date|date:"Y-m-d" }}</td>
                                    <td>{{ log.start_time|time:"H:i" }}</td>
                                    <td>{{ log.finish_time|time:"H:i" }}</td>
                                    <td>{{ log.get_op_display }}</td>
                                    <td>{{ log.get_rating_display }}</td>
                                    <td>{{ log.initial.code|default:"-" }}</td>
                                    <td>{{ log.trainee.code|default:"-" }}</td>
                                    <td>{{ log.ojti.code|default:"-" }}</td>
                                    <td>{{ log.examiner.code|default:"-" }}</td>
                                     {# Example duration calc (less reliable than aggregate) #}
                                     {# {% if log.finish_time %}
                                     <!-- <td> Calculate duration here if needed, maybe via templatetag </td> -->
                                     {% else %}<td>-</td>{% endif %} #}
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                 {% else %}
                     <p class="mt-3 alert alert-warning">No specific log entries matched these criteria (but the total duration was calculated).</p>
                {% endif %}

            </div>
        </div>
        {% elif request.GET and not form.is_valid %}
         <div class="alert alert-warning">
             Please correct the errors in the filter form above.
         </div>
        {% elif request.GET and form.is_valid and total_hours == 0 %}
           <div class="alert alert-info">
                No duty logs with recorded finish times matched the specified criteria within the date range. Total duration is 0 hours.
                <br><br>
                 <p>Filters applied:</p>
                <ul>
                    <li><strong>Date Range:</strong> {{ submitted_filters.start_date|date:"Y-m-d" }} to {{ submitted_filters.end_date|date:"Y-m-d" }}</li>
                    <li><strong>Initial:</strong> {{ submitted_filters.initial }}</li>
                    <li><strong>Operation Type:</strong> {{ submitted_filters.op }}</li>
                    <li><strong>Rating:</strong> {{ submitted_filters.rating }}</li>
                </ul>
            </div>
        {% elif not request.GET %}
            <div class="alert alert-secondary">
                Please select filters and click "Generate Report".
            </div>
        {% endif %}

    </div>
</div>
{% endblock %}